**代码结构**

在本代码库中，V2Sim 的核心代码存储在 `v2sim` 文件夹中。此外，`v2sim/tools/sim_single.py` 提供了启动仿真实例的方法。本文档将介绍 `v2sim` 文件夹的结构，该文件夹可以部署为一个软件包，正如上一篇文章中所介绍的那样。

+ V2Sim 软件包
  + traffic: 核心模块
    + cs.py: 充电站，包含快充站和慢充站，它们继承自一个基类 CS。
    + cslist.py: 充电站集合的包装器，支持集合操作。
    + ev.py: 电动汽车和行程。
    + evdict.py: 电动汽车集合的包装器，支持集合操作。
    + trip.py: 行程记录器、行程事件监听器和行程日志文件读取器。
    + utils.py: 辅助和杂项功能函数。
    + inst.py: 整个包含电动汽车和充电站的交通仿真的包装器。
  + trafficgen: 数据生成模块
  + statistics: 数据记录模块
  + plugins: 插件和外部代码调用模块
  + plotkit: 结果绘图模块
  + locale: 语言辅助模块
  + sim_core.py: V2Sim 仿真实例包装器

## cs.py
+ **慢充站**: 提供慢速充电，通常功率较低，充电时间较长。车辆使用 `chi` 和 `free` 进行分类：
    - `chi`: 当前正在充电的车辆，使用 `MaxPCAllocator`。
    - `free`: 已充满电的车辆，可用于向电网进行车对网放电。
    - **慢充站不实现排队机制。** 由于慢充站通常充电时间较长，一般不考虑等待队列。车辆在充满电后保持连接状态，以便可用于车对网调度，因此没有专门的排队状态。
    - **只有慢充站执行特定的车对网逻辑**，检查车辆是否愿意参与车对网。

+ **快充站**: 提供快速充电，通常功率较高，充电时间较短。车辆状态分为两类：`chi` 和 `buf`。
    - `chi`: 当前正在充电的车辆。
    - `buf`: 等待充电的车辆。
    - 当有充电桩可用时，`buf` 队列中的车辆依次进入 `chi` 状态进行充电。车辆在充满电后立即离开充电站。释放的充电桩随后分配给等待队列中的下一辆车，遵循先到先得、"充满即走"的原则。
    - **快充站不支持车对网。** 充电功率由分配器动态分配给每个正在充电的车辆。因此，只调用 `MaxPCAllocator`，不调用 `V2GAllocator` 等与车对网相关的功能。

+ 关于 `MaxPCAllocator` 和 `V2GAllocator` 的详细信息，请参阅 [代码扩展](dev/exts) 部分。

## ev.py
电动汽车模块由四个类组成：`Trip`、`VehStatus`、`EV` 和 `ChargeRatePool`。这四个部分通过类间协作共同实现完整的仿真过程。

### 电动汽车
+ 初始化阶段：通过输入电动汽车的ID、行程列表、电池和能耗参数等，配置基本属性并初始化状态（默认为停车状态）。

+ 行程执行阶段：电动汽车通过 `next_trip` 切换到下一个行程。在SUMO确认出发后，进入行驶状态。在行驶过程中，实时扣除电量并更新里程。到达目的地后，返回到停车状态，循环直到所有行程完成。

+ 特殊场景处理阶段：
  - 如果在行驶过程中电量不足，电动汽车切换到充电状态，根据指定策略进行充电，计算成本，并在充电完成后恢复行程。
  - 如果在停车时满足充电/车对网条件，则主动进入充电/车对网状态。
  - 如果电池电量耗尽，首先进入耗尽状态，在被救援到充电站后恢复充电。

### 行程
行程类用于描述单个出行任务，主要描述车辆要去哪里、何时出发、起点和终点以及路线等属性。

| 属性 | 意义 |
|---|---|
| trip_id | 此行程的ID，用于标识 |
| depart_time | 出发时间（仿真时间戳，单位通常为秒） |
| from_TAZ | 起点交通分析小区（此参数不参与仿真，无实际意义） |
| to_TAZ | 终点交通分析小区（此参数不参与仿真，无实际意义） |
| route | 路径，由一系列道路ID组成 |
| fixed_route | 路线是否固定（是否允许重新规划路线；此参数目前无法正常使用） |
| additional | 用户自定义的可选附加信息字典（例如，乘客数量、车辆类型、其他标签等） |

### 车辆状态
类 VehStatus 是一个继承自 `enum.IntEnum` 的枚举类。其核心功能是明确定义电动汽车（EV 类）的 5 个核心运行状态。以下是车辆的五种状态类型：

| 值 | 名称 | 含义 | 典型发生场景 |
|---|---|---|---|
| 0 | 行驶中 | 行驶状态 | 车辆正在移动，目的地是行程终点或目标充电站 |
| 1 | 等待中 | 等待启动状态 | 已向SUMO（交通仿真软件）发送启动命令，但车辆尚未在SUMO中实际开始移动 |
| 2 | 充电中 | 充电状态 | 车辆静止在充电站，通过快充或慢充补充电量 |
| 3 | 停车中 | 停车/停止状态 | 车辆静止且未充电，包括：行程间的间隔、首次行程前的待命期、最后一次行程结束后的停车期 |
| 4 | 已耗尽 | 电池耗尽状态 | 电池电量降至0，车辆无法继续行驶，需要紧急充电或救援 |

### 充电速率池
代码包含一个池函数 `ChargeRatePool`。其核心目的是统一存储、调用和扩展不同的充电速率计算逻辑，使得电动汽车的充电速率策略可配置和可扩展，避免在 `EV` 类中硬编码速率计算。代码默认在 `_pool` 中预填充了两种最常用的充电速率逻辑，对应两个内部函数。

| 策略 | 对应函数 | 核心逻辑 | 适用场景 |
|---|---|---|---|
| 等量 | `_EqualChargeRate` | 无修正，直接返回输入的 `rate` | 理想快充场景（荷电状态不影响速率） |
| 线性 | `_LinearChargeRate` | 分段修正：当 `EV.SOC ≤ 0.8` 时返回 `rate`；当 `EV.SOC > 0.8` 时返回 `rate × (3.4 - 3×EV.SOC)` | 相对真实的快充场景（速率随荷电状态增加衰减更明显） |

示例：如果基础速率 `rate = 0.01 千瓦时/秒`（即 36 千瓦），且电动汽车的 荷电状态 = 0.9，则在 `线性` 策略下的实际速率为：`0.01 × (3.4 - 3 × 0.9) = 0.01 × 0.7 = 0.007 千瓦时/秒`（即 25.2 千瓦），这与真实快充后期速率下降的特性相符。