# 代码结构

在本代码库中，V2Sim 的核心代码存储在 `v2sim` 文件夹中。此外，`sim_single.py` 提供了启动仿真实例的方法。本文将介绍 `v2sim` 文件夹的结构，该文件夹可以按照上一篇文章的介绍部署为软件包。

+ V2Sim 包
  + traffic: 核心模块
    + cs.py: 充电站，包含 FCS 和 SCS，继承自基类 CS
    + cslist.py: CS 集合的包装器，支持集合操作
    + ev.py: 电动汽车和行程
    + evdict.py: EV 集合的包装器，支持集合操作
    + trip.py: 行程记录器、行程事件监听器和行程日志文件读取器
    + utils.py: 辅助函数和杂项功能
    + inst.py: 整个交通仿真（包含电动汽车和充电站）的包装器
  + trafficgen: 数据生成模块
  + statistics: 数据记录模块
  + plugins: 插件和外部代码调用模块
  + plotkit: 结果绘图模块
  + locale: 语言辅助模块
  + sim_core.py: V2Sim 仿真实例包装器

## cs.py
+ SCS慢充站：慢充，通常功率低，充电时间长。车辆用chi和free区分：chi表示正在充电，调用MaxPCAllocator；free表示充满，采用V2G放电给电网。
  - SCS 不排队，慢充站一般充电时间长，通常不考虑等待队列，充满后仍保持连接以备V2G调度，所以没有设立排队的状态。
  - 仅慢充站会执行V2G的特殊逻辑，监测车辆是否有意愿参与V2G。

+ FCS快充站：快充站（FCS）通常功率高，充电时间短。车辆状态分为两类：chi 表示正在充电，buf 表示等待充电。
  - 当充电桩有空闲时，buf 中的车辆会依次进入 chi 充电。车辆充满电后立即离开充电站，释放的充电桩会被等待队列中的车辆占用，遵循先到先得，充满即走的原则。
  - FCS 不支持 V2G，充电功率按分配器动态分配给每辆正在充电的车辆。因此只调用MaxPCAllocator，不调用V2G相关的V2GAllocator函数。

+ MaxPcAlloctor和V2GAllocater请参见[代码扩展](/zh_hans/v2sim/dev/exts)。
  
## ev.py
整个EV部分的代码有四个类，分别是`Trip`, `VehStatus`, `EV`和`ChargeRatePool`。四部分通过类间协同实现完整仿真流程。

### EV
+ 初始化阶段：通过输入 EV 的 ID、行程列表、电池与能耗参数等，完成基础属性配置与状态初始化（默认停驶状态）；

+ 行程执行阶段，EV 通过next_trip切换至下一行程，待 SUMO确认启动后进入行驶状态，行驶中实时扣减电量、更新里程，到达终点后回归停驶状态，循环直至完成所有行程；

+ 特殊场景处理阶段：
  - 若行驶中电量不足，EV 会切换至充电状态，按指定策略充电并计算成本，充电完成后恢复行程；
  - 若停驶时满足充电 / V2G 条件，则主动进入充电 / V2G状态；
  - 若电量耗尽，则先进入耗尽状态，待救援至充电站后恢复充电。

### Trip
Trip 类用于描述一次出行任务，主要是用于描述车辆要去哪、什么时候出发、从哪里到哪里、怎么走等属性。

|属性|意义|
|---|---|
|trip_id|本次行程的 ID，用于标识|
|depart_time|出发时间（仿真时间戳，单位通常为秒）|
|from_TAZ|出发的交通区域（该参数不参与仿真，无实际意义）|
|to_TAZ|到达的交通区域（该参数不参与仿真，无实际意义）|
|route|路径，由一系列道路ID组成|
|fixed_route|路线是否固定（是否允许路径重规划，该参数暂时不能正常使用）|
|additional|用户自定义可选附加信息字典（比如：乘客数、车辆类型、其他标签等）|


### VehStatus
Class VehStatus 是继承自enum.IntEnum的枚举类，核心作用是明确定义电动车（EV类）的 5 种核心运行状态，以下是车辆的五个状态类型：

|数值|名称|含义|典型出现场景|
|---|---|---|---|
|0|Driving|行驶状态|车辆正在移动，目的地为行程终点（Trip.toTAZ）或目标充电站（EV._cs）|
|1|Pending|待启动状态|已向 SUMO（交通仿真软件）发送启动指令，但车辆在 SUMO 中尚未实际启动|
|2|Charging|充电状态|车辆停留在充电站，正在通过快充（EV._efc_rate）或慢充（EV._esc_rate）补充电量|
|3|Parking|停驶状态|车辆静止且未充电，包括：两个行程之间的间隔期、首个行程开始前的待命期、最后一个行程结束后的停放期|
|4|Depleted|电量耗尽状态|电池电量（EV._elec）降至 0，车辆无法继续行驶，需紧急充电或救援|

### ChargeRatePool
代码中有一个池函数ChargeRatePool，核心作用是统一存储、调用和扩展不同的充电速率计算逻辑，让 EV 的充电速率策略可配置、可扩展，避免将速率计算代码在 EV 类中，代码默认在 _pool 中预置了 2 种最常用的充电速率逻辑，对应两个内部函数。

|策略|对应函数|核心逻辑|适用场景|
|---|---|---|---|
|Equal|_EqualChargeRate|不修正，直接返回输入的 rate|理想快充场景（SOC 不影响速率）|
|Linear|_LinearChargeRate|分段修正：当 EV.SOC ≤ 0.8 时，返回 rate；当 EV.SOC > 0.8 时，返回 rate × (3.4 - 3×EV.SOC)|相对真实的快充场景（SOC 越高，速率衰减越明显）|

举例：若基础速率 rate=0.01 kWh/s（即 36 kW），当 EV 的 SOC=0.9 时，Linear 策略的实际速率为：0.01 × (3.4 - 3×0.9) = 0.01 × 0.7 = 0.007 kWh/s（即 25.2 kW），符合真实快充后期速率下降的特性。
