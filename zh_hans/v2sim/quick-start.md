# 快速开始

## A. 环境配置

1.  **安装 Python**：访问 `https://www.python.org/download` 获取 Python (需要版本 >=3.9。旧版本可能无法正常运行本程序)。

2.  **下载代码**。您可以直接点击 GitHub 页面上的 `download` 按钮下载代码，或者安装 `git` 后使用以下命令之一克隆仓库。关于使用 `git` 的官方教程在[这里](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)。
```bash
# 仅克隆 v2sim 的发布版本
git clone -b main --single-branch https://github.com/fmy-xfk/v2sim.git
# 克隆 v2sim, v2sim-ux 以及它们的开发分支
git clone https://github.com/fmy-xfk/v2sim.git
```

3.  **安装必要的包**。确保您已安装随 Python 附带的 `pip`。**注意**：对于 `libsumo` 包，其版本必须与 SUMO 的版本一致！
```bash
python -m ensurepip
python -m pip install -r requirements.txt
```

## B. 创建案例
在 `cases` 文件夹中有 3 个预定义的案例：`std_12nodes`, `std_37nodes` 和 `std_Nanjing`。您可以直接使用这 3 个案例，或者从头开始创建一个新案例。

**创建新案例的完整教程：**

1.  **下载交通路网**：使用 `gui_osmWizard.py` 来下载路网。运行此脚本后，您的浏览器将被打开并显示地图。<br> ![alt text](/imgs/1.png)
    +   您可以输入城市名称并点击 `Search` 来定位，或者输入经纬度并点击 `Go to`。由于网络和现代浏览器的限制，`Use current location` 功能可能无法工作。
    +   默认情况下，将下载您屏幕上显示的整个地图区域。您可以勾选 `Select area` 复选框来仅选择一个矩形区域。
    +   您可以根据自己的偏好调整 `Options` 中的项目。
    +   在第二个标签页中，默认仅勾选 `highway`。不推荐勾选其他选项，因为 V2Sim 不会模拟这些道路上的车辆运动。
    +   在适当配置后，点击 `Generate Scenario` 按钮。案例将在 `cases` 文件夹中生成，并以当前时间命名。案例生成后，`gui_main.py` 将自动打开。界面类似下图：<br> ![alt text](/imgs/0.png)
    +   如果生成的案例未被自动选中，请点击 `Add project...` 链接，选择您创建的文件夹，然后打开它。您将看到类似这样的内容：<br> ![alt text](/imgs/3.png)

**注意**：如果您想要修改路网，请使用 SUMO 的 `netedit` 工具。如果 Python 已被添加到环境变量 `PATH` 中，您可以在命令提示符中使用 `netedit` 命令来启动该程序。

2.  **下载充电站位置**：如果您下载的区域在**中国大陆**，您可以在本程序中下载充电站位置。否则，请跳过此步骤。
    +   切换到 `充电站下载` 页面，在给定的输入框中键入一个高德地图开发者密钥。**注意：您必须在[高德地图官方网站](https://lbs.amap.com/)上申请一个 Web服务 的密钥。没有密钥此功能将无法工作。**
    +   点击 `Download` 以从高德地图获取充电站位置。下载充电站位置时请耐心等待。如果给定区域内的充电站过多，由于高德地图的限制，可能无法全部下载。
    +   成功的结果如下所示（地址均为中文，因为它们位于中国）：
    ![alt text](/imgs/4.png)
    +   下载充电站位置后，请关闭项目编辑器并重新打开，以避免编辑器中任何潜在的错误。

3.  **生成充电站**：分别切换到 `快充站` 和 `慢充站` 以生成不同类型的充电站。如果您使用的是真实世界的路网，我们强烈建议您从下载的位置生成充电站。点击 `Generate` 按钮生成充电站。
    +   即使看起来没有反应，也请**不要**重复点击 `Generate`。进度将在命令提示符中显示，而不会弹出另一个窗口。
    +   生成快充站和慢充站是必需的，即使不需要某种充电站，也需要一个只有根节点的xml文件占位。
    +   成功的结果类似这样：
    ![alt text](/imgs/5.png)

4.  **编辑电网**：切换到 `网络` 页面以查看路网（蓝色）和配电网（黑色）。按住鼠标右键可以平移视图。左键单击可以移动和编辑配电网。**但是，此处无法编辑路网。请使用 SUMO NetEdit。**
    ![alt text](/imgs/11.png)
    （细长矩形 = 母线，三角形 = 光伏/风力发电机，正方形 = 储能装置，圆形 = 发电机）

5.  **生成车辆**：切换到 `车辆` 页面以生成车辆。如果您使用的是真实世界的路网，我们强烈建议您根据建筑物的轮廓和类型生成行程。
    +   即使看起来没有反应，也请**不要**重复点击 `生成充电站`。进度将在命令提示符中显示，而不会弹出另一个窗口。

6.  **开始仿真**：确保左侧栏中的 `快充站`, `慢充站`, `路网` 和 `车辆` 都不是 `None`。然后返回 `仿真` 页面，勾选您想要的统计项目，并点击 `开始仿真!`。

## C. 仿真
一旦您点击了 `开始仿真!`，窗口将会关闭。仿真期间请耐心等待。在仿真一个大型真实路网时，可能会花费数小时。您可以在命令提示符中查看进度和预计所需时间。

如果您想并行运行多个仿真（这可以充分利用您的 CPU），您可以使用 `gui_para.py`。当您想更改特定参数以衡量其影响时，此功能非常有用。如下图所示：
![alt text](/imgs/10.png)

### D. 查看结果
仿真完成后，运行 `gui_viewer.py` 并打开案例。结果位于案例文件夹中，有一个名为 `results` 的子文件夹。它将类似这样：
![alt text](/imgs/6.png)

#### 绘图
勾选您想要绘制相应图形的项目。点击 `Plot` 按钮来绘制图形。结果图形将存储在 `results\<case_name>\figures` 中。

**注意：** 某些项目可能不可用，因为在配置项目时未选择相应的统计项目，因此未生成该数据。

**比较两个结果：** 使用 `gui_cmp.py` 在同一页面中显示两个结果，这使您更容易识别差异。如下图所示：
![gui_cmp](/imgs/9.png)

**更高级的绘图：** GUI 版本的绘图功能相当有限。您可以访问 [Wiki](https://github.com/fmy-xfk/v2sim/wiki) 以获取更好的绘图工具：`cmd_advplot.py` 和 `cmd_plot.py`。前者提供高度可定制的绘图体验，而后者支持对批量结果文件夹进行绘图。

#### 电网信息
您还可以在 `Grid` 页面收集特定时间点的电网数据。输入时间点，然后点击 `Collect`。
![alt text](/imgs/7.png)

#### 行程查看器
行程也会在 `Trips` 页面进行统计。您可以通过在窗口底部附带的栏中给出条件来筛选它们。您还可以将筛选后的结果保存到特定文件。
![alt text](/imgs/8.png)

#### 状态查看器
如果您在仿真前勾选了 "Save state ..."，状态将保存在结果文件夹中。您可以在该页面中查看 FCS、SCS 和 EV 的状态。
![alt text](/imgs/12.png)